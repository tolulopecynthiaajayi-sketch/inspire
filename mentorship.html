<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration & Mentorship | Alora Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="./js/firebaseConfig.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #FFF7ED;
        }

        h1,
        h2,
        h3,
        h4,
        .nav-text {
            font-family: 'Montserrat', sans-serif;
        }

        .bg-navy-primary {
            background-color: #1E3A8A;
        }

        .bg-navy-dark {
            background-color: #0F172A;
        }

        .text-navy-primary {
            color: #1E3A8A;
        }

        .bg-peach-accent {
            background-color: #D9654C;
        }

        .text-peach-accent {
            color: #D9654C;
        }

        .border-peach-accent {
            border-color: #D9654C;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconName = name.charAt(0).toUpperCase() + name.slice(1);
            if (!window.lucide || !window.lucide.icons || !window.lucide.icons[iconName]) return null;
            const iconDef = window.lucide.icons[iconName];
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconDef.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // SHARED NAVIGATION BAR for accessibility across portals
        const NavBar = () => (
            <nav className="bg-navy-dark text-white shadow-md sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4">
                    <div className="flex justify-between h-20 items-center">
                        <div className="flex items-center gap-3">
                            <a href="index.html">
                                <img src="logo.png" alt="Alora" className="h-12 w-auto object-contain filter invert mix-blend-screen" />
                            </a>
                            <span className="font-bold text-white text-lg tracking-wider border-l border-gray-600 pl-4 ml-2 nav-text">INSPIRE INTEGRATION</span>
                        </div>



                        <div className="flex items-center gap-4">
                            <a href="#" className="flex items-center gap-2 text-peach-accent text-sm font-bold uppercase hover:text-white transition">
                                <Icon name="logOut" size={16} /> Sign Out
                            </a>
                        </div>
                    </div>
                </div>
            </nav>
        );

        const Dashboard = () => {
            const [activeTab, setActiveTab] = useState('matches');
            const [showContractModal, setShowContractModal] = useState(false);
            const [selectedMentee, setSelectedMentee] = useState(null);
            const [mentees, setMentees] = useState([]);
            const [agreements, setAgreements] = useState([]);

            // Fetch Real Mentorship Requests (Incoming from Students)
            useEffect(() => {
                if (!window.db) return;
                // In a real app, we might filter by 'status' == 'pending' or similar
                const unsubscribe = window.db.collection('mentorship_requests')
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const requests = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            // Fallback for missing data if the student profile wasn't fully copied
                            name: doc.data().studentName || 'Unknown Student',
                            matchScore: Math.floor(Math.random() * (98 - 75 + 1) + 75) // AI Match Score (Mock for now)
                        }));
                        setMentees(requests);
                    }, err => console.error("Error fetching mentorship requests", err));
                return () => unsubscribe();
            }, []);

            // Fetch My Agreements
            useEffect(() => {
                if (!window.db) return;
                // Mocking current user ID as 'mentor_1' for now
                const unsubscribe = window.db.collection('mentorship_requests').where('mentorId', '==', 'mentor_1')
                    .onSnapshot(snapshot => {
                        const ags = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setAgreements(ags);
                    });
                return () => unsubscribe();
            }, []);

            const initiateContract = (mentee) => {
                setSelectedMentee(mentee);
                setShowContractModal(true);
            };

            const handleSignAndSend = async () => {
                try {
                    // Update the EXISTING request instead of creating a new one
                    await window.db.collection('mentorship_requests').doc(selectedMentee.id).update({
                        mentorId: 'mentor_1', // Current user ID (mock for now)
                        status: 'Signed by Mentor',
                        signedAt: new Date().toISOString()
                    });
                    alert(`Contract sent to ${selectedMentee.name} for signature!`);
                    setShowContractModal(false);
                    setActiveTab('agreements');
                } catch (e) {
                    console.error("Error creating agreement", e);
                    alert("Failed to send contract.");
                }
            };

            return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* Header */}
                    <header className="mb-8 flex justify-between items-end">
                        <div>
                            <h1 className="text-3xl font-bold text-navy-primary mb-2">Integration & Mentorship</h1>
                            <p className="text-gray-600">Connect with international students and help them settle in France.</p>
                        </div>
                        <div className="bg-white px-4 py-2 rounded shadow-sm border border-gray-200">
                            <span className="text-xs font-bold text-gray-400 uppercase block">Your Profile Status</span>
                            <span className="text-green-600 font-bold flex items-center gap-1"><Icon name="checkCircle" size={16} /> Verified Mentor</span>
                        </div>
                    </header>

                    {/* Tabs */}
                    <div className="flex gap-6 border-b border-gray-300 mb-8">
                        <button
                            onClick={() => setActiveTab('matches')}
                            className={`pb-4 px-2 font-bold text-sm uppercase transition ${activeTab === 'matches' ? 'text-navy-primary border-b-4 border-navy-primary' : 'text-gray-400 hover:text-navy-primary'}`}
                        >
                            Smart Matches
                        </button>
                        <button
                            onClick={() => setActiveTab('agreements')}
                            className={`pb-4 px-2 font-bold text-sm uppercase transition ${activeTab === 'agreements' ? 'text-navy-primary border-b-4 border-navy-primary' : 'text-gray-400 hover:text-navy-primary'}`}
                        >
                            My Agreements
                        </button>
                    </div>

                    {/* CONTENT Area */}
                    <div className="min-h-[400px]">

                        {/* MATCHES SECTION */}
                        {activeTab === 'matches' && (
                            <div className="animate-fade-in grid md:grid-cols-3 gap-6">
                                {mentees.map(mentee => (
                                    <div key={mentee.id} className="bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 hover:shadow-xl transition group">
                                        <div className="h-20 bg-gradient-to-r from-blue-600 to-navy-primary relative">
                                            <div className="absolute top-4 right-4 bg-white/20 backdrop-blur px-2 py-1 rounded text-white text-xs font-bold">
                                                {mentee.matchScore}% Compatibility
                                            </div>
                                        </div>
                                        <div className="px-6 pb-6 relative">
                                            <div className="w-16 h-16 -mt-8 bg-white p-1 rounded-full mb-3">
                                                <div className="w-full h-full bg-gray-200 rounded-full flex items-center justify-center text-gray-500 font-bold text-xl">
                                                    {mentee.name.charAt(0)}
                                                </div>
                                            </div>

                                            <h3 className="font-bold text-lg text-gray-900">{mentee.name}</h3>
                                            <p className="text-sm text-gray-500 mb-4">{mentee.origin} â€¢ {mentee.program}</p>

                                            <div className="flex flex-wrap gap-2 mb-6">
                                                {(mentee.details?.interests || ['General Integration']).slice(0, 3).map((tag, i) => (
                                                    <span key={i} className="text-[10px] uppercase font-bold bg-blue-50 text-blue-700 px-2 py-1 rounded">{tag}</span>
                                                ))}
                                            </div>

                                            <button
                                                onClick={() => initiateContract(mentee)}
                                                className="w-full py-2 bg-navy-primary text-white font-bold rounded-lg text-sm hover:bg-navy-dark transition flex items-center justify-center gap-2"
                                            >
                                                Start Mentorship <Icon name="arrowRight" size={16} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* AGREEMENTS SECTION */}
                        {activeTab === 'agreements' && (
                            <div className="animate-fade-in space-y-4">
                                {agreements.length === 0 ? (
                                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
                                        <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4 text-gray-400">
                                            <Icon name="fileText" size={32} />
                                        </div>
                                        <h3 className="font-bold text-gray-900 mb-2">No Active Agreements</h3>
                                        <p className="text-gray-500 max-w-md mx-auto mb-6">Once you match with a student and sign the digital mentorship contract, it will appear here for your reference.</p>
                                        <button onClick={() => setActiveTab('matches')} className="text-peach-accent font-bold text-sm hover:underline">Find a Mentee</button>
                                    </div>
                                ) : (
                                    agreements.map(ag => (
                                        <div key={ag.id} className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center">
                                            <div>
                                                <h3 className="font-bold text-navy-primary text-lg">{ag.studentName}</h3>
                                                <p className="text-xs text-gray-500">Sent on: {new Date(ag.createdAt).toLocaleDateString()}</p>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${ag.status === 'Pending Signature' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                                    {ag.status}
                                                </span>
                                                <button className="text-gray-400 hover:text-navy-primary"><Icon name="moreVertical" /></button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                    </div>

                    {/* CONTRACT MODAL */}
                    {showContractModal && selectedMentee && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fade-in p-4">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden">
                                <div className="bg-navy-primary text-white p-6 flex justify-between items-center">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="penTool" /> Mentorship Contract</h3>
                                    <button onClick={() => setShowContractModal(false)} className="text-white/70 hover:text-white"><Icon name="x" /></button>
                                </div>
                                <div className="p-6 max-h-[60vh] overflow-y-auto bg-gray-50">
                                    <div className="bg-white p-8 shadow-sm border border-gray-200 mb-6">
                                        <h2 className="text-center font-bold text-xl text-navy-primary mb-6 uppercase tracking-widest border-b pb-4">Mentorship Agreement</h2>

                                        <div className="space-y-6 text-sm text-gray-700">
                                            <p><strong>Parties:</strong></p>
                                            <ul className="list-disc pl-5">
                                                <li><strong>Mentor:</strong> [Current User]</li>
                                                <li><strong>Mentee:</strong> {selectedMentee.name}</li>
                                            </ul>

                                            <p><strong>Commitment:</strong></p>
                                            <p>The Mentor agrees to provide guidance, cultural insight, and support to help the Mentee integrate into life in France. This includes at least one meeting per month.</p>

                                            <p><strong>Duration:</strong></p>
                                            <p>This agreement is valid for one academic semester, renewable upon mutual agreement.</p>
                                        </div>

                                        <div className="mt-8 pt-8 border-t border-gray-100 flex justify-between items-end">
                                            <div className="w-1/2 pr-4">
                                                <div className="h-12 border-b-2 border-dashed border-gray-300 mb-2"></div>
                                                <p className="text-xs uppercase font-bold text-gray-400">Signature of Mentor</p>
                                            </div>
                                            <div className="w-1/2 pl-4">
                                                <div className="h-12 border-b-2 border-dashed border-gray-300 mb-2 bg-gray-50 flex items-center px-2 text-xs italic text-gray-400">
                                                    Waiting for {selectedMentee.name}...
                                                </div>
                                                <p className="text-xs uppercase font-bold text-gray-400">Signature of Mentee</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-gray-100 bg-white flex justify-end gap-3">
                                    <button onClick={() => setShowContractModal(false)} className="px-4 py-2 border border-gray-300 text-gray-600 font-bold rounded text-sm hover:bg-gray-50">Cancel</button>
                                    <button
                                        onClick={handleSignAndSend}
                                        className="px-6 py-2 bg-green-600 text-white font-bold rounded text-sm hover:bg-green-700 shadow flex items-center gap-2"
                                    >
                                        <Icon name="send" size={16} /> Sign & Send
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        };

        const App = () => (
            <div>
                <NavBar />
                <Dashboard />
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>