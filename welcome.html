<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to Alora</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
        }

        h1,
        h2,
        h3 {
            font-family: 'Montserrat', sans-serif;
        }

        .bg-navy-primary {
            background-color: #1E3A8A;
        }

        .text-navy-primary {
            color: #1E3A8A;
        }

        .text-peach-accent {
            color: #D9654C;
        }

        .bg-peach-accent {
            background-color: #D9654C;
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.8s ease-out forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        .delay-300 {
            animation-delay: 0.3s;
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 h-screen flex flex-col items-center justify-center relative overflow-hidden">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="./js/firebaseConfig.js?v=force_reload_1"></script>

    <!-- Background Elements -->
    <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
        <div class="absolute -top-32 -right-32 w-96 h-96 bg-navy-primary/5 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-32 -left-32 w-96 h-96 bg-peach-accent/10 rounded-full blur-3xl"></div>
    </div>

    <div class="bg-white p-10 rounded-2xl shadow-xl max-w-lg w-full text-center relative mx-4">
        <!-- Brand Logo -->
        <img src="logo.png" alt="Alora" class="h-16 w-auto mx-auto mb-8 object-contain animate-fade-in-up" />

        <!-- Personalized Greeting -->
        <h1 id="greeting" class="text-3xl font-bold text-navy-primary mb-2 animate-fade-in-up delay-100">
            Welcome to Alora!
        </h1>
        <p id="role-badge"
            class="inline-block px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider bg-gray-100 text-gray-500 mb-6 animate-fade-in-up delay-100">
            Setting things up...
        </p>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="animate-fade-in-up delay-200">
            <!-- Loading State -->
            <div class="flex flex-col items-center gap-4 py-8">
                <div class="w-8 h-8 border-4 border-navy-primary border-t-transparent rounded-full animate-spin"></div>
                <p class="text-gray-500 text-sm">Personalizing your experience...</p>
            </div>
        </div>

        <!-- Logout (Emergency Exit) -->
        <button onclick="logout()"
            class="mt-8 text-gray-400 text-xs hover:text-red-500 underline animate-fade-in-up delay-300">
            Log out & Return Home
        </button>

        <!-- Toast Notification (Hidden by default) -->
        <div id="toast"
            class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50">
            Notification Message
        </div>
    </div>

    <script>
        lucide.createIcons();

        // UI Helper: Show Toast
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-10 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg transition-opacity duration-300 z-50 ${isError ? 'bg-red-600' : 'bg-gray-800'} text-white opacity-100`;

            setTimeout(() => {
                toast.className = toast.className.replace('opacity-100', 'opacity-0');
            }, 3000);
        }

        function initWelcome() {
            if (!window.auth) return;

            // Wait briefly for auth state to stabilize
            window.auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // Fetch profile
                    try {
                        const userDoc = await window.db.collection('users').doc(user.uid).get();

                        if (userDoc.exists) {
                            const data = userDoc.data();
                            renderWelcome(user, data);
                        } else {
                            // Fallback
                            renderWelcome(user, { name: user.displayName || 'Friend', role: 'Member' });
                        }
                    } catch (e) {
                        console.error("Profile load error:", e);
                        renderWelcome(user, { name: user.displayName || 'Friend', role: 'Member' });
                    }
                } else {
                    // Not logged in? Redirect to login
                    setTimeout(() => window.location.href = 'login.html', 1500);
                }
            });
        }

        function checkAndInit() {
            if (window.auth && window.db) {
                initWelcome();
                return true;
            }
            return false;
        }

        // aggressive strategy
        if (!checkAndInit()) {
            const timer = setInterval(() => {
                if (checkAndInit()) {
                    clearInterval(timer);
                }
            }, 100);

            // Give up after 3 seconds
            setTimeout(() => {
                clearInterval(timer);
            }, 3000);
        }

        function renderWelcome(user, profile) {
            const greeting = document.getElementById('greeting');
            const roleBadge = document.getElementById('role-badge');
            const content = document.getElementById('content-area');

            // Personalize
            const firstName = profile.name ? profile.name.split(' ')[0] : 'there';
            greeting.textContent = `Welcome, ${firstName}!`;

            const roleLabel = profile.role ? profile.role.charAt(0).toUpperCase() + profile.role.slice(1) : 'Member';
            roleBadge.textContent = roleLabel;
            roleBadge.className = `inline-block px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider mb-6 text-white shadow-md ${getRoleColor(profile.role)}`;

            // Check Verification Status
            if (!user.emailVerified) {
                // start auto-checker
                startVerificationPoller(user);

                // Scenario A: Verification Needed
                content.innerHTML = `
                <div class="bg-blue-50 border border-blue-100 rounded-lg p-6 mb-6">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="mail" width="24" height="24"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Verify your Email</h3>
                    <p class="text-gray-600 text-sm mb-4">
                        We've sent a link to <strong class="text-gray-800">${user.email}</strong>.<br>
                        Please click it to activate your ${roleLabel} account.
                    </p>
                    <button onclick="checkVerification()" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition mb-3">
                        I've Verified It
                    </button>
                    <button onclick="resendEmail()" class="text-blue-600 text-sm font-semibold hover:underline">
                        Resend Link
                    </button>
                </div>
            `;
            } else {
                // Scenario B: Ready to Go
                content.innerHTML = `
                <div class="text-center py-4">
                    <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce">
                        <i data-lucide="check" width="32" height="32"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">You're All Set!</h3>
                    <p class="text-gray-600 text-sm mb-8 max-w-xs mx-auto">
                        Your dashboard has been configured and is ready for you.
                    </p>
                    <button onclick="goToDashboard('${profile.role}')" class="w-full bg-navy-primary text-white font-bold py-4 rounded-lg shadow-lg hover:bg-navy-secondary transition transform hover:-translate-y-1">
                        Go to My Dashboard <i data-lucide="arrow-right" class="inline w-4 h-4 ml-1"></i>
                    </button>
                </div>
            `;
            }
            lucide.createIcons();
        }

        function getRoleColor(role) {
            switch (role) {
                case 'student': return 'bg-navy-primary';
                case 'landlord': return 'bg-peach-accent';
                case 'corporate': return 'bg-slate-800';
                case 'family': return 'bg-purple-600';
                case 'admin': return 'bg-red-700';
                default: return 'bg-gray-500';
            }
        }

        async function checkVerification() {
            const user = window.auth.currentUser;
            await user.reload(); // Force refresh from server
            if (user.emailVerified) {
                showToast("Email verified! Redirecting...", false);
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast("Not yet verified! Please check your inbox.", true);
            }
        }

        async function resendEmail() {
            try {
                const user = window.auth.currentUser;
                await user.sendEmailVerification();
                showToast("Verification link resent!", false);
            } catch (e) {
                showToast("Error sending email. Try again later.", true);
            }
        }

        // Auto-Check Verification Status
        function startVerificationPoller(user) {
            if (user.emailVerified) return; // Already good

            const poller = setInterval(async () => {
                await user.reload();
                if (user.emailVerified) {
                    clearInterval(poller);
                    showToast("Email verified! Redirecting...", false);
                    setTimeout(() => location.reload(), 2000);
                }
            }, 3000); // Check every 3 seconds
        }

        function goToDashboard(role) {
            switch (role) {
                case 'student': window.location.href = 'student.html'; break;
                case 'landlord': window.location.href = 'landlord.html'; break;
                case 'corporate': window.location.href = 'corporate.html'; break;
                case 'family': window.location.href = 'mentorship.html'; break;
                case 'admin': window.location.href = 'admin.html'; break;
                default: window.location.href = 'index.html';
            }
        }

        async function logout() {
            await window.auth.signOut();
            window.location.href = 'index.html';
        }
    </script>
</body>

</html>