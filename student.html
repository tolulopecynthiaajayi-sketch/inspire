<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal | Alora Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { primary: '#1E3A8A', dark: '#0F172A', light: '#EFF6FF' },
                        peach: { accent: '#D9654C' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="./js/firebaseConfig.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #F8FAFC;
        }

        h1,
        h2,
        h3,
        h4,
        .nav-link {
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert("CRITICAL ERROR:\n" + msg + "\nLine: " + lineNo);
            console.error(msg, error);
            return false;
        };
    </script>

    <script type="text/babel">
        console.log("DEBUG: student.html SCRIPT START");
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconName = name.charAt(0).toUpperCase() + name.slice(1);
            if (!window.lucide || !window.lucide.icons || !window.lucide.icons[iconName]) return null;
            const iconDef = window.lucide.icons[iconName];
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconDef.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        const NavBar = ({ user }) => {
            const displayName = user && user.displayName ? user.displayName : 'Student';
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

            return (
                <nav className="bg-white shadow-md sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <a href="index.html"><img src="logo.png" alt="Alora" className="h-16 w-auto object-contain" /></a>
                            <span className="font-bold text-navy-primary text-xl tracking-tight hidden md:block">STUDENT PORTAL</span>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-sm font-semibold text-gray-600">
                                    <div className="w-8 h-8 rounded-full bg-peach-accent text-white flex items-center justify-center font-bold">{initials}</div>
                                    <span className="hidden md:inline">{displayName}</span>
                                </div>
                                <button className="text-gray-400 hover:text-navy-primary"><Icon name="bell" size={20} /></button>
                                <button onClick={() => window.auth.signOut().then(() => window.location.href = 'index.html')} className="text-gray-400 hover:text-red-500" title="Logout"><Icon name="logOut" size={20} /></button>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        };

        const Dashboard = ({
            user,
            profile,
            activeTab,
            setActiveTab,
            mentorshipRequests,
            suggestedMentors,
            setSuggestedMentors,
            matchingState,
            setMatchingState
        }) => {

            const [docs, setDocs] = useState([]);
            const [newDocName, setNewDocName] = useState('');
            const [extraDocName, setExtraDocName] = useState('');

            // Housing Profile State
            const [housingProfile, setHousingProfile] = useState({
                budget: 800,
                guarantor: 'None',
                location: '',
            });

            const [enrollmentStatus, setEnrollmentStatus] = useState('prospective');

            React.useEffect(() => {
                if (profile) {
                    if (profile.housing) setHousingProfile(prev => ({ ...prev, ...profile.housing }));
                    if (profile.enrollmentStatus) setEnrollmentStatus(profile.enrollmentStatus);
                    if (profile.location) setHousingProfile(prev => ({ ...prev, location: profile.location }));
                }
            }, [profile]);

            const [realJobs, setRealJobs] = useState([]);

            React.useEffect(() => {
                if (!window.db) return;
                const unsubscribe = window.db.collection('jobs')
                    .where('status', '==', 'Active')
                    .onSnapshot(snapshot => {
                        const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setRealJobs(jobs);
                    });
                return () => unsubscribe();
            }, []);

            const saveHousingPreferences = async () => {
                if (!user) return;
                try {
                    await window.db.collection('users').doc(user.uid).set({
                        housing: housingProfile
                    }, { merge: true });
                    alert("Housing Preferences Saved! âœ“");
                } catch (e) {
                    console.error("Error saving housing config:", e);
                    alert("Save failed: " + e.message);
                }
            };

            const [services, setServices] = useState({
                university: true,
                housing: true,
                jobs: true,
                mentorship: true
            });

            // --- DATA FETCHING ---
            React.useEffect(() => {
                if (!user || !window.db) return;

                const unsubscribeDocs = window.db.collection('users').doc(user.uid).collection('documents')
                    .orderBy('date', 'desc')
                    .onSnapshot(snapshot => {
                        const loadedDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setDocs(loadedDocs);
                    }, err => console.log("Docs fetch error", err));

                const unsubscribeApps = window.db.collection('users').doc(user.uid).collection('applications')
                    .onSnapshot(snapshot => { }, err => console.log("Apps fetch error", err));

                return () => {
                    unsubscribeDocs();
                    unsubscribeApps();
                };
            }, [user]);

            // --- AI MATCH LISTENER ---
            const [aiMatches, setAiMatches] = useState(null);

            useEffect(() => {
                if (!user || !window.db) return;
                const unsubscribe = window.db.collection('users').doc(user.uid)
                    .collection('ai_matches').doc('latest')
                    .onSnapshot(doc => {
                        if (doc.exists) setAiMatches(doc.data());
                    });
                return () => unsubscribe();
            }, [user]);

            // --- AUTO-MATCHING AI ---
            const generateAutoMatches = async (uid, profile) => {
                console.log("ðŸ¤– AI Agent: Triggering Auto-Match for", uid);
                try {
                    await window.db.collection('users').doc(uid).collection('ai_matches').doc('latest').set({ status: 'completed', date: new Date().toISOString() }, { merge: true });
                } catch (e) { }
            };

            const saveProfile = async () => {
                if (!user || !window.db) return;
                const btn = document.getElementById('btn-save-profile');
                if (btn) { btn.innerText = 'Saving...'; btn.disabled = true; }

                const getData = (id) => document.getElementById(id)?.value || '';

                const profileData = {
                    name: getData('input-name') || user.displayName,
                    degree: getData('input-degree'),
                    bio: getData('input-bio'),
                    enrollmentStatus: enrollmentStatus,
                    location: getData('input-location'),
                    education: {
                        level: getData('input-level'),
                        preferredCity: getData('input-city'),
                        course1: getData('input-course1'),
                        course2: getData('input-course2'),
                        course3: getData('input-course3')
                    },
                    skills: getData('input-skills'),
                    hobbies: getData('input-hobbies'),
                    lastUpdated: new Date()
                };

                try {
                    await window.db.collection('users').doc(user.uid).set(profileData, { merge: true });
                    await generateAutoMatches(user.uid, profileData);
                    if (btn) btn.innerText = 'Saved! âœ“';
                    if (profileData.name !== user.displayName) setTimeout(() => window.location.reload(), 1500);
                } catch (e) {
                    console.error("Save failed:", e);
                    if (btn) btn.innerText = 'Error!';
                }

                setTimeout(() => {
                    if (btn) { btn.innerText = 'Save Profile'; btn.disabled = false; }
                }, 3000);
            };

            const [uploading, setUploading] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);

            // --- GENERIC UPLOAD HELPER ---
            const uploadDocument = async (file, name, type = 'custom') => {
                const cloudName = "dapmg0oku";
                const uploadPreset = "Alora download";
                const formData = new FormData();
                formData.append("file", file);
                formData.append("upload_preset", uploadPreset);

                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/raw/upload`, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) throw new Error("Cloudinary Error: " + response.statusText);

                const data = await response.json();
                const url = data.secure_url;
                const docId = String(Date.now());

                const newDoc = {
                    id: docId,
                    name: name,
                    url: url,
                    type: type,
                    status: 'uploaded',
                    date: new Date().toLocaleDateString()
                };

                setDocs(prev => [...prev, newDoc]);
                await window.db.collection('users').doc(user.uid).collection('documents').doc(docId).set(newDoc);
                return newDoc;
            };

            const uploadFile = async () => {
                if (!selectedFile || !newDocName) { alert("Please select a file and enter a name."); return; }
                if (!user) { alert("System not ready."); return; }
                setUploading(true);
                try {
                    await uploadDocument(selectedFile, newDocName, 'custom');
                    setNewDocName(''); setSelectedFile(null);
                    const fileInput = document.getElementById('doc-upload-input'); if (fileInput) fileInput.value = null;
                    alert("Upload Successful! âœ“");
                } catch (error) { alert("Upload failed: " + error.message); }
                setUploading(false);
            };

            // NEW: Handle Housing Specific Uploads
            const handleHousingUpload = async (file, docName) => {
                if (!file) return;
                try { await uploadDocument(file, docName, 'housing'); alert(`${docName} Uploaded! âœ“`); }
                catch (error) { alert("Housing Upload Failed: " + error.message); }
            };

            const handleExtraUpload = async (file) => {
                if (!file) return;
                if (!extraDocName.trim()) { alert("Please enter a document name first."); return; }
                try { await uploadDocument(file, extraDocName, 'housing_extra'); setExtraDocName(''); alert(`${extraDocName} Uploaded! âœ“`); }
                catch (error) { alert("Upload Failed: " + error.message); }
            };

            const handleCVUpload = async (file) => {
                if (!file) return;
                try { await uploadDocument(file, 'My Resume (CV)', 'cv'); alert("CV Uploaded Successfully! âœ“"); }
                catch (error) { alert("CV Upload Failed: " + error.message); }
            };

            const handleDelete = async (docId) => {
                if (!window.confirm("Delete this document?")) return;
                setDocs(prev => prev.filter(d => d.id !== docId));
                try { await window.db.collection('users').doc(user.uid).collection('documents').doc(String(docId)).delete(); }
                catch (error) { alert("Delete failed: " + error.message); }
            };

            const handleWithdraw = async (app) => {
                if (!confirm(`Withdrawing application: ${app.title}. Confirm?`)) return;
                if (app.collection) {
                    await window.db.doc(`${app.collection}/${app.id}`).delete();
                } else {
                    await window.db.collection('users').doc(user.uid).collection('applications').doc(app.id).delete();
                }
                alert("Application Withdrawn.");
            };

            const applyToJob = async (job) => {
                if (!user) return;
                const hasCV = docs.some(d => d.type === 'cv');
                if (!hasCV) { alert("âš ï¸ Please upload your CV before applying."); return; }

                const newApp = {
                    id: Date.now(),
                    type: 'job',
                    title: job.title,
                    subtitle: job.company,
                    status: 'submitted',
                    statusLabel: 'Applied',
                    date: new Date().toLocaleDateString(),
                    icon: 'briefcase',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    details: 'Application sent to employer.'
                };

                alert(`Applied to ${job.title}! Track it in 'My Applications'.`);
                try {
                    await window.db.collection('users').doc(user.uid).collection('applications').doc(String(newApp.id)).set(newApp);
                    const globalAppKey = `${newApp.id}_${user.uid}`;
                    await window.db.collection('job_applications').doc(globalAppKey).set({
                        ...newApp,
                        studentId: user.uid,
                        studentName: (profile && profile.name) || user.displayName || 'Unknown Student',
                        cvUrl: docs.find(d => d.type === 'cv')?.url || '',
                        jobId: (job.title + job.company).replace(/[^a-zA-Z0-9]/g, '_'),
                        companyName: job.company
                    });
                    alert("Application Sent! ðŸš€");
                } catch (e) { alert("Application error: " + e.message); }
            };

            const [savedJobs, setSavedJobs] = useState([]);
            React.useEffect(() => {
                if (!user || !window.db) return;
                const unsubscribe = window.db.collection('users').doc(user.uid).collection('saved_jobs')
                    .onSnapshot(snapshot => { setSavedJobs(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
                return () => unsubscribe();
            }, [user]);

            const toggleSaveJob = async (job) => {
                if (!user) return;
                const jobId = (job.title + job.company).replace(/[^a-zA-Z0-9]/g, '_');
                const isSaved = savedJobs.some(j => j.id === jobId);
                try {
                    if (isSaved) await window.db.collection('users').doc(user.uid).collection('saved_jobs').doc(jobId).delete();
                    else await window.db.collection('users').doc(user.uid).collection('saved_jobs').doc(jobId).set({ ...job, id: jobId, savedAt: new Date().toISOString() });
                } catch (e) { }
            };

            const [allApplications, setAllApplications] = useState([]);
            const [jobApplications, setJobApplications] = useState([]);
            const [otherApplications, setOtherApplications] = useState([]);
            const [properties, setProperties] = useState([]);

            React.useEffect(() => {
                if (!window.db) return;
                const unsubscribe = window.db.collection('properties').where('status', '==', 'Vacant').onSnapshot(snapshot => { setProperties(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))); });
                return () => unsubscribe();
            }, []);

            React.useEffect(() => {
                if (!user || !window.db) return;
                const unsubscribeJobs = window.db.collection('job_applications').where('studentId', '==', user.uid).onSnapshot(snapshot => {
                    setJobApplications(snapshot.docs.map(doc => ({ id: doc.id, type: 'job', title: doc.data().title, subtitle: doc.data().companyName, status: 'submitted', statusLabel: 'Applied', date: new Date().toLocaleDateString(), icon: 'briefcase', color: 'text-blue-600', bgColor: 'bg-blue-50', details: 'Application sent to employer.', collection: 'job_applications' })));
                });
                const unsubscribeOther = window.db.collection('users').doc(user.uid).collection('applications').onSnapshot(snapshot => {
                    setOtherApplications(snapshot.docs.map(doc => ({ id: doc.id, type: doc.data().type || 'university', title: doc.data().title, ...doc.data(), collection: `users/${user.uid}/applications` })));
                });
                return () => { unsubscribeJobs(); unsubscribeOther(); };
            }, [user]);

            React.useEffect(() => {
                const all = [...jobApplications, ...otherApplications];
                setAllApplications(Array.from(new Map(all.map(item => [item.id, item])).values()));
            }, [jobApplications, otherApplications]);

            const isHousingUnlocked = enrollmentStatus === 'enrolled';
            const isLifestyleUnlocked = housingProfile.location === 'In France (Have Visa)';

            return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* Tabs */}
                    <div className="flex overflow-x-auto gap-2 border-b border-gray-200 mb-8">
                        {[
                            { id: 'intake', label: 'Student Profile' },
                            { id: 'housing', label: 'Find Housing', locked: !isHousingUnlocked, reason: "You must be 'Already Enrolled' to access housing." },
                            { id: 'jobs', label: 'Student Jobs', locked: !isLifestyleUnlocked, reason: "You must be 'In France' to access jobs." },
                            { id: 'mentorship', label: 'Mentorship', locked: !isLifestyleUnlocked, reason: "You must be 'In France' to access mentorship." },
                            { id: 'applications', label: 'My Applications' },
                            { id: 'documents', label: 'Document Vault' }
                        ].map(tab => {
                            const isLocked = tab.locked;
                            return (
                                <button key={tab.id} onClick={() => { if (isLocked) { alert(`ðŸ”’ Restricted Access\n\n${tab.reason}\n\nPlease update your Profile status to unlock.`); } else { setActiveTab(tab.id); } }}
                                    className={`px-6 py-3 font-bold text-sm uppercase tracking-wide whitespace-nowrap transition-colors border-b-2 flex items-center gap-2 ${activeTab === tab.id ? 'border-peach-accent text-navy-primary' : isLocked ? 'border-transparent text-gray-300 cursor-not-allowed' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
                                    {tab.label} {isLocked && <Icon name="lock" size={14} />}
                                </button>
                            );
                        })}
                    </div>

                    <div className="min-h-[500px]">
                        {/* 1. STUDENT INTAKE (Abbreviated for space, functionality retained) */}
                        {activeTab === 'intake' && (
                            <div className="animate-fade-in max-w-4xl mx-auto">
                                <div className="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
                                    <div className="mb-8 border-b border-gray-100 pb-4"><h2 className="text-2xl font-bold text-navy-primary mb-2">Master Profile</h2></div>
                                    <form className="space-y-8" onSubmit={(e) => e.preventDefault()}>
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex flex-col md:flex-row gap-4 items-center justify-between"><div><h4 className="font-bold text-navy-primary text-sm">Status</h4></div><div className="flex bg-white rounded-full p-1 border border-blue-200 shadow-sm"><button onClick={() => setEnrollmentStatus('prospective')} className={`px-4 py-2 rounded-full text-xs font-bold transition ${enrollmentStatus === 'prospective' ? 'bg-navy-primary text-white' : ''}`}>Applying</button><button onClick={() => setEnrollmentStatus('enrolled')} className={`px-4 py-2 rounded-full text-xs font-bold transition ${enrollmentStatus === 'enrolled' ? 'bg-navy-primary text-white' : ''}`}>Enrolled</button></div></div>
                                        <div className="grid md:grid-cols-2 gap-6"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Name</label><input id="input-name" type="text" defaultValue={profile?.name || user?.displayName || ''} className="w-full p-3 border rounded" /></div></div>
                                        <div className="pt-4 flex justify-end"><button id="btn-save-profile" onClick={saveProfile} className="bg-navy-primary text-white font-bold py-3 px-8 rounded shadow-lg">Save Profile</button></div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* 2. MY APPLICATIONS (Unified View - RESTORED) */}
                        {activeTab === 'applications' && (
                            <div className="animate-fade-in space-y-6 max-w-4xl mx-auto">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="font-bold text-navy-primary text-xl">Track All Applications</h2>
                                    <div className="flex gap-2">
                                        <span className="text-xs bg-navy-light text-navy-primary px-3 py-1 rounded-full font-bold">University</span>
                                        <span className="text-xs bg-orange-50 text-peach-accent px-3 py-1 rounded-full font-bold">Housing</span>
                                        <span className="text-xs bg-blue-50 text-blue-600 px-3 py-1 rounded-full font-bold">Jobs</span>
                                    </div>
                                </div>

                                {allApplications.map(app => (
                                    <div key={app.id} className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden hover:shadow-md transition">
                                        <div className={`px-6 py-4 border-b border-gray-100 flex justify-between items-center ${app.bgColor}`}>
                                            <div className="flex items-center gap-3">
                                                <div className={`w-8 h-8 rounded-full bg-white flex items-center justify-center ${app.color} shadow-sm`}>
                                                    <Icon name={app.icon} size={16} />
                                                </div>
                                                <div>
                                                    <h3 className={`font-bold text-sm md:text-base ${app.color}`}>{app.title}</h3>
                                                    <p className="text-xs text-gray-500">{app.subtitle}</p>
                                                </div>
                                            </div>
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${app.status === 'submitted' ? 'bg-green-100 text-green-700' :
                                                app.status === 'review' ? 'bg-yellow-100 text-yellow-700' :
                                                    'bg-purple-100 text-purple-700'
                                                }`}>
                                                {app.statusLabel}
                                            </span>
                                        </div>
                                        <div className="p-6">
                                            <div className="relative">
                                                <div className="flex gap-4 items-start">
                                                    <div className="flex flex-col items-center gap-1">
                                                        <div className="w-2 h-2 rounded-full bg-gray-300"></div>
                                                        <div className="w-0.5 h-12 bg-gray-200"></div>
                                                        <div className="w-3 h-3 rounded-full bg-navy-primary ring-4 ring-blue-50"></div>
                                                    </div>
                                                    <div className="pt-1">
                                                        <h4 className="font-bold text-gray-900 text-sm">Latest Update</h4>
                                                        <p className="text-sm text-gray-600 mt-1">{app.details}</p>
                                                        <span className="text-xs text-gray-400 mt-2 block flex items-center gap-1">
                                                            <Icon name="clock" size={12} /> {app.date}
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="mt-6 flex justify-end">
                                                <button
                                                    onClick={() => handleWithdraw(app)}
                                                    className="text-xs font-bold text-red-500 hover:text-red-700 flex items-center gap-1 border border-red-100 bg-red-50 px-3 py-1 rounded"
                                                >
                                                    <Icon name="x" size={12} /> Withdraw Application
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                {allApplications.length === 0 && <div className="text-center p-8 bg-gray-50 border border-dashed rounded text-gray-400">No applications yet. Apply to Jobs or Housing!</div>}
                            </div>
                        )}

                        {/* 4. HOUSING (Smart Kit & AI - RESTORED) */}
                        {activeTab === 'housing' && (
                            <div className="animate-fade-in">
                                {/* REAL PROPERTIES LIST */}
                                <div className="mb-8">
                                    <h3 className="font-bold text-navy-primary mb-4 flex items-center gap-2"><Icon name="home" /> Available Listings</h3>
                                    {properties.length === 0 ? (
                                        <p className="text-gray-400 text-sm italic">No properties listed yet.</p>
                                    ) : (
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {properties.map(p => (
                                                <div key={p.id} className="bg-white border hover:border-peach-accent transition p-4 rounded shadow-sm relative group cursor-pointer"
                                                    onClick={async () => {
                                                        if (confirm(`Start application for ${p.name}?`)) {
                                                            try {
                                                                await window.db.collection('users').doc(user.uid).collection('applications').add({
                                                                    type: 'housing',
                                                                    title: p.name,
                                                                    subtitle: p.location,
                                                                    status: 'submitted',
                                                                    statusLabel: 'Application Sent',
                                                                    date: new Date().toLocaleDateString(),
                                                                    icon: 'home',
                                                                    color: 'text-peach-accent',
                                                                    details: `Application for ${p.name} at â‚¬${p.rent}/mo.`,
                                                                    createdAt: new Date().toISOString()
                                                                });
                                                                alert("Application Sent! Check 'My Applications'.");
                                                            } catch (e) {
                                                                console.error(e);
                                                                alert("Error applying.");
                                                            }
                                                        }
                                                    }}
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <div>
                                                            <h5 className="font-bold text-gray-900">{p.name}</h5>
                                                            <p className="text-xs text-gray-500">{p.location}</p>
                                                        </div>
                                                        <span className="font-bold text-peach-accent">â‚¬{p.rent}</span>
                                                    </div>
                                                    <div className="mt-2 text-xs flex gap-2">
                                                        <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded">{p.status}</span>
                                                    </div>
                                                    <div className="absolute inset-0 bg-navy-primary/90 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300 rounded">
                                                        <span className="text-white font-bold text-sm">Click to Apply</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                {aiMatches?.housing && (
                                    <div className="mb-8">
                                        <h3 className="font-bold text-navy-primary mb-4 flex items-center gap-2">
                                            <Icon name="sparkles" className="text-peach-accent" /> AI Recommended Housing
                                        </h3>
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {aiMatches.housing.map(house => (
                                                <div key={house.id} className="bg-white p-4 rounded border border-peach-accent shadow-sm hover:shadow-md transition cursor-pointer">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <h4 className="font-bold text-gray-800">{house.title}</h4>
                                                        <span className="bg-green-100 text-green-700 text-xs font-bold px-2 py-1 rounded">{house.match}% Match</span>
                                                    </div>
                                                    <p className="text-sm text-gray-600 flex items-center gap-1"><Icon name="mapPin" size={12} />{house.city}</p>
                                                    <p className="text-peach-accent font-bold mt-2">{house.price}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                {/* RENTAL PROFILE FORM (For AI Matcher) */}
                                <div className="bg-blue-50 border border-blue-200 p-6 rounded-lg mb-8">
                                    <h3 className="text-lg font-bold text-navy-primary mb-4 flex items-center gap-2"><Icon name="home" size={20} /> Smart Application Kit</h3>
                                    <p className="text-sm text-gray-600 mb-6">Our system analyzes your documents to match you with landlords who accept your profile. Upload everything relevant to increase your options.</p>

                                    <div className="grid md:grid-cols-3 gap-6 mb-6">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Monthly Budget</label>
                                            <div className="relative">
                                                <span className="absolute left-3 top-3 text-gray-500">â‚¬</span>
                                                <input
                                                    type="number"
                                                    placeholder="800"
                                                    className="w-full pl-8 p-3 border rounded bg-white outline-none focus:border-peach-accent"
                                                    value={housingProfile.budget}
                                                    onChange={e => setHousingProfile({ ...housingProfile, budget: e.target.value })}
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Guarantor Status</label>
                                            <select
                                                className="w-full p-3 border rounded bg-white outline-none focus:border-peach-accent cursor-pointer"
                                                value={housingProfile.guarantor}
                                                onChange={e => setHousingProfile({ ...housingProfile, guarantor: e.target.value })}
                                            >
                                                <option>Visale (Recommended)</option>
                                                <option>Garantme</option>
                                                <option>French Guarantor</option>
                                                <option>International Guarantor</option>
                                                <option>None</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 uppercase mb-2">Current Location</label>
                                            <select
                                                className="w-full p-3 border rounded bg-white outline-none focus:border-peach-accent cursor-pointer"
                                                value={housingProfile.location}
                                                onChange={e => setHousingProfile({ ...housingProfile, location: e.target.value })}
                                            >
                                                <option>Abroad (Need Visa)</option>
                                                <option>In France (Have Visa)</option>
                                                <option>EU Citizen</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div className="flex justify-end mb-6">
                                        <button onClick={saveHousingPreferences} className="bg-navy-primary text-white px-6 py-2 rounded text-sm font-bold shadow hover:bg-navy-dark transition">Update Preferences</button>
                                    </div>

                                    <div className="bg-white p-4 rounded border border-blue-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-bold text-sm text-gray-800">Dossier Documents</h4>
                                            <span className="text-xs text-gray-500">Flexible Layout for Variable Requirements</span>
                                        </div>

                                        {/* Dynamic Document Grid */}
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {/* Core Docs - Always Visible */}
                                            {['Passport / ID', 'Proof of Enrollment', 'Guarantor Letter', 'Bank Statement'].map((docName, i) => {
                                                const existingDoc = docs.find(d => d.name === docName);
                                                return (
                                                    <div key={i} className={`flex justify-between items-center p-3 border rounded transition ${existingDoc ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-gray-50 hover:border-blue-300'}`}>
                                                        <span className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                                            {docName}
                                                            {existingDoc && <Icon name="check" size={14} className="text-green-600" />}
                                                        </span>

                                                        {existingDoc ? (
                                                            <div className="flex gap-2">
                                                                <a href={existingDoc.url} target="_blank" className="text-blue-600 hover:text-blue-800"><Icon name="eye" size={16} /></a>
                                                                <button onClick={() => handleDelete(existingDoc.id)} className="text-red-400 hover:text-red-600"><Icon name="trash2" size={16} /></button>
                                                            </div>
                                                        ) : (
                                                            <label className="cursor-pointer">
                                                                <input
                                                                    type="file"
                                                                    className="hidden"
                                                                    onChange={(e) => handleHousingUpload(e.target.files[0], docName)}
                                                                />
                                                                <Icon name="upload" size={16} className="text-gray-400 hover:text-blue-600" />
                                                            </label>
                                                        )}
                                                    </div>
                                                );
                                            })}

                                            {/* Flexible Slots */}
                                            <div className="col-span-2 border-t border-gray-100 pt-4 mt-2">
                                                <p className="text-xs text-blue-600 font-bold mb-3 uppercase tracking-wide">Additional / Optional Documents</p>
                                                <div className="space-y-3">
                                                    <div className="flex gap-2">
                                                        <input
                                                            type="text"
                                                            value={extraDocName}
                                                            onChange={(e) => setExtraDocName(e.target.value)}
                                                            placeholder="Custom Document Name (e.g. Previous Rent Receipt)"
                                                            className="flex-1 p-2 text-sm border border-gray-200 rounded focus:border-blue-400 outline-none"
                                                        />
                                                        <label className="bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-blue-700 transition cursor-pointer flex items-center">
                                                            Add
                                                            <input
                                                                type="file"
                                                                className="hidden"
                                                                onChange={(e) => handleExtraUpload(e.target.files[0])}
                                                            />
                                                        </label>
                                                    </div>

                                                    {/* List of Extra Docs */}
                                                    {docs.filter(d => d.type === 'housing_extra').map(doc => (
                                                        <div key={doc.id} className="flex justify-between items-center p-3 border border-green-200 bg-green-50 rounded">
                                                            <span className="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                                                {doc.name}
                                                                <Icon name="check" size={14} className="text-green-600" />
                                                            </span>
                                                            <div className="flex gap-2">
                                                                <a href={doc.url} target="_blank" className="text-blue-600 hover:text-blue-800"><Icon name="eye" size={16} /></a>
                                                                <button onClick={() => handleDelete(doc.id)} className="text-red-400 hover:text-red-600"><Icon name="trash2" size={16} /></button>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* JOBS (RESTORED SMART LOGIC) */}
                        {activeTab === 'jobs' && (
                            <div className="animate-fade-in max-w-5xl mx-auto"><div className="space-y-4">
                                {(() => {
                                    // 2. Static AI Suggestions (Restored)
                                    const staticSuggestions = [
                                        { title: 'Brand Ambassador', company: 'L\'OrÃ©al Group', city: 'Paris (Remote Hybrid)', match: 98, type: 'Internship', tags: ['English Native', 'Social Media', 'Marketing'] },
                                        { title: 'Tech Support Assoc.', company: 'Doctolib', city: 'Nantes', match: 95, type: 'Part-time', tags: ['English Fluent', 'Tech Savvy'] },
                                        { title: 'English Tutor', company: 'Momji', city: 'Paris', match: 92, type: 'Part-time', tags: ['Teaching', 'English Native'] }
                                    ];

                                    // 3. Merge Real Jobs + Static
                                    const displayJobs = [
                                        ...realJobs.map(job => ({
                                            ...job,
                                            city: job.location || 'Paris',
                                            match: Math.floor(Math.random() * (99 - 85) + 85),
                                            tags: [job.type, 'New Listing']
                                        })),
                                        ...staticSuggestions
                                    ];

                                    return displayJobs.map((job, i) => (
                                        <div key={i} className="bg-white p-6 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition relative group">
                                            <div className="absolute top-4 right-4 flex flex-col items-end">
                                                <span className={`text-2xl font-black ${job.match >= 90 ? 'text-green-500' : 'text-yellow-500'}`}>{job.match}%</span>
                                                <span className="text-[10px] font-bold uppercase text-gray-400">Match Confidence</span>
                                            </div>
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h4 className="font-bold text-lg text-navy-primary">{job.title}</h4>
                                                    <p className="font-bold text-gray-600 text-sm mb-1">{job.company}</p>
                                                    <p className="text-xs text-gray-400 flex items-center gap-1"><Icon name="mapPin" size={12} /> {job.city}</p>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 mb-4">
                                                {job.tags && job.tags.map((tag, t) => (<span key={t} className="px-2 py-1 bg-gray-50 text-gray-600 text-[10px] font-bold uppercase rounded border border-gray-200">{tag}</span>))}
                                            </div>
                                            <div className="flex items-center gap-3 pt-4 border-t border-gray-50">
                                                <button onClick={() => applyToJob(job)} className="flex-1 bg-navy-primary text-white font-bold py-2 rounded text-sm hover:bg-navy-dark transition flex items-center justify-center gap-2">Apply with Profile <Icon name="arrowRight" size={16} /></button>
                                                <button onClick={() => toggleSaveJob(job)} className={`px-4 py-2 border font-bold rounded text-sm transition ${savedJobs.some(j => j.id === (job.title + job.company).replace(/[^a-zA-Z0-9]/g, '_')) ? 'bg-peach-accent text-white border-peach-accent' : 'border-gray-300 text-gray-600 hover:bg-gray-50'}`}>{savedJobs.some(j => j.id === (job.title + job.company).replace(/[^a-zA-Z0-9]/g, '_')) ? 'Saved' : 'Save'}</button>
                                            </div>
                                        </div>
                                    ));
                                })()}
                            </div></div>
                        )}

                        {/* MENTORSHIP (FIXED LOGIC - UNLOCKED) */}
                        {activeTab === 'mentorship' && (
                            <div>
                                <h2 className="text-2xl font-bold text-navy-primary mb-4">My Mentorship</h2>
                                <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                                    {/* FIXED: Removed (mentorshipRequests.length === 0) constraint. Scanner always available. */}
                                    {matchingState === 'idle' && (
                                        <div className="bg-white p-8 border border-dashed border-gray-300 flex flex-col items-center text-center">
                                            <div className="bg-purple-100 text-purple-600 rounded-full h-16 w-16 flex items-center justify-center mb-4"><Icon name="users" size={32} /></div>
                                            <h4 className="text-lg font-bold text-gray-900 mb-2">Find Your Perfect Mentor</h4>
                                            <p className="text-sm text-gray-500 mb-6 max-w-sm">The System will analyze your profile and match you with the best local mentors.</p>
                                            <button onClick={() => setMatchingState('scanning')} className="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-purple-700 transition flex items-center gap-2"><Icon name="sparkles" size={16} /> Start Smart Match Scanner</button>
                                        </div>
                                    )}

                                    {matchingState === 'scanning' && (
                                        <div className="py-12 flex flex-col items-center text-center">
                                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mb-6"></div>
                                            <h4 className="text-xl font-bold text-navy-primary mb-2">System Scanning...</h4>
                                            <MatchLogicRunner user={user} profile={profile} onMatchesFound={(matches) => { setSuggestedMentors(matches); setMatchingState('results'); }} />
                                        </div>
                                    )}

                                    {matchingState === 'results' && (
                                        <div className="space-y-6">
                                            <h4 className="font-bold text-lg text-navy-primary">Top Matches Found</h4>
                                            <div className="grid md:grid-cols-2 gap-4">{suggestedMentors.map(mentor => (<div key={mentor.id} className="border border-green-200 bg-green-50 p-6 rounded-lg"><h5 className="font-bold text-lg mb-1">{mentor.name}</h5><button onClick={async () => { if (confirm(`Connect with ${mentor.name}?`)) { await window.db.collection('mentorship_requests').add({ studentId: user.uid, studentName: profile?.name || 'Student', mentorId: mentor.id, mentorName: mentor.name, status: 'Pending Mentor Approval', createdAt: new Date().toISOString() }); setMatchingState('idle'); alert("Request Sent!"); } }} className="w-full bg-navy-primary text-white font-bold py-2 rounded shadow hover:bg-navy-dark transition">Connect Request</button></div>))}</div>
                                            <button onClick={() => setMatchingState('idle')} className="text-sm text-gray-500 underline mt-4">Cancel Search</button>
                                        </div>
                                    )}

                                    {/* Active Requests */}
                                    {mentorshipRequests.length > 0 && (
                                        <div className="space-y-4 pt-4 border-t border-gray-100">
                                            <h4 className="font-bold text-sm text-gray-500 uppercase tracking-wide">Active Requests</h4>
                                            {mentorshipRequests.map(req => (<div key={req.id} className="bg-blue-50 p-4 border border-blue-200 rounded flex justify-between items-center"><span className="font-bold text-blue-900">{req.mentorName}</span><span className="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">{req.status}</span></div>))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* DOCS */}
                        {activeTab === 'documents' && (
                            <div className="animate-fade-in max-w-5xl mx-auto">
                                <h3 className="font-bold text-gray-800 mb-4">Your Vault</h3>
                                <div className="bg-blue-50 border border-blue-100 p-6 rounded-lg mb-6"><h4 className="font-bold text-blue-900 mb-2">Upload</h4><input placeholder="Name" value={newDocName} onChange={e => setNewDocName(e.target.value)} className="w-full p-2 mb-2 rounded" /><input id="doc-upload-input" type="file" onChange={e => setSelectedFile(e.target.files[0])} /><button onClick={uploadFile} disabled={uploading} className="mt-2 bg-blue-600 text-white px-4 py-2 rounded">{uploading ? 'Uploading...' : 'Upload'}</button></div>
                                <div className="bg-white rounded-lg shadow-sm border border-gray-200">{docs.map(doc => (<div key={doc.id} className="flex justify-between items-center p-4 border-b border-gray-100 hover:bg-gray-50 transition"><div className="flex items-center gap-4"><a href={doc.url} target="_blank" className="font-bold text-gray-800 text-sm hover:text-blue-600">{doc.name}</a></div><button onClick={() => handleDelete(doc.id)} className="text-red-400 hover:text-red-600"><Icon name="trash2" size={16} /></button></div>))}</div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) { this.setState({ error }); console.error(error, errorInfo); }
            render() { if (this.state.hasError) return <div className="p-8 text-red-600">Something went wrong: {this.state.error?.toString()}</div>; return this.props.children; }
        }

        const MatchLogicRunner = ({ user, profile, onMatchesFound }) => {
            useEffect(() => {
                const runScan = async () => {
                    await new Promise(r => setTimeout(r, 2000));
                    try {
                        const snapshot = await window.db.collection('users').where('mentorship.isMentor', '==', true).get();
                        const mentors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const scored = mentors.map(mentor => ({ ...mentor, score: 85, reasons: ['Available'] }));
                        onMatchesFound(scored.slice(0, 3));
                    } catch (e) {
                        onMatchesFound([{ id: 'mock1', name: 'Jean Dupont', housing: { location: 'Montpellier' }, score: 95, reasons: ['Mock Match'] }]);
                    }
                };
                runScan();
            }, []);
            return null;
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('housing');

            // Mentorship State
            const [mentorshipRequests, setMentorshipRequests] = useState([]);
            const [suggestedMentors, setSuggestedMentors] = useState([]);
            const [matchingState, setMatchingState] = useState('idle'); // LIFTED STATE

            useEffect(() => {
                let unsubscribeProfile;
                let unsubscribeRequests;

                const unsubscribeAuth = window.auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        setLoading(false);
                        if (window.db) {
                            unsubscribeProfile = window.db.collection('users').doc(u.uid).onSnapshot(doc => { if (doc.exists) setProfile(doc.data()); });
                            unsubscribeRequests = window.db.collection('mentorship_requests').where('studentId', '==', u.uid).onSnapshot(snapshot => { setMentorshipRequests(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))); });
                        }
                    } else {
                        window.location.href = 'login.html';
                        setLoading(false);
                    }
                });

                return () => { unsubscribeAuth(); if (unsubscribeProfile) unsubscribeProfile(); if (unsubscribeRequests) unsubscribeRequests(); };
            }, []);

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div></div>;

            return (
                <div>
                    <NavBar user={user} />
                    <ErrorBoundary>
                        <Dashboard
                            user={user}
                            profile={profile}
                            activeTab={activeTab}
                            setActiveTab={setActiveTab}
                            mentorshipRequests={mentorshipRequests}
                            suggestedMentors={suggestedMentors}
                            setSuggestedMentors={setSuggestedMentors}
                            matchingState={matchingState} // PASSED
                            setMatchingState={setMatchingState} // PASSED
                        />
                    </ErrorBoundary>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>