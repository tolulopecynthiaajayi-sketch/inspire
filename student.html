<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal | Alora Group</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: { primary: '#0A192F', dark: '#020C1B', light: '#112240' },
                        peach: { accent: '#D9654C' }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="./js/firebaseConfig.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Open+Sans:wght@400;600&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Open Sans', sans-serif;
            background-color: #F8FAFC;
        }

        h1,
        h2,
        h3,
        h4,
        .nav-link {
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert("CRITICAL ERROR:\n" + msg + "\nLine: " + lineNo);
            console.error(msg, error);
            return false;
        };
    </script>

    <script type="text/babel">
        console.log("DEBUG: student.html SCRIPT START");
        const { useState, useEffect } = React;

        const Icon = ({ name, size = 20, className = "" }) => {
            const iconName = name.charAt(0).toUpperCase() + name.slice(1);
            if (!window.lucide || !window.lucide.icons || !window.lucide.icons[iconName]) return null;
            const iconDef = window.lucide.icons[iconName];
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconDef.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        const NavBar = ({ user }) => {
            const displayName = user && user.displayName ? user.displayName : 'Student';
            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

            return (
                <nav className="bg-white shadow-md sticky top-0 z-50">
                    <div className="max-w-7xl mx-auto px-4 h-20 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <span className="text-xl font-bold text-navy-primary tracking-tight">ALORA<span className="text-peach-accent">STUDENT</span></span>
                        </div>
                        <div className="flex items-center gap-6">
                            <div className="flex items-center gap-2">
                                <div className="flex items-center gap-2 text-sm font-semibold text-gray-600">
                                    <div className="w-8 h-8 rounded-full bg-peach-accent text-white flex items-center justify-center font-bold">{initials}</div>
                                    <span className="hidden md:inline">{displayName}</span>
                                </div>
                                <button className="text-gray-400 hover:text-navy-primary"><Icon name="bell" size={20} /></button>
                                <button onClick={() => window.auth.signOut().then(() => window.location.href = 'index.html')} className="text-gray-400 hover:text-red-500" title="Logout"><Icon name="logOut" size={20} /></button>
                            </div>
                        </div>
                    </div>
                </nav>
            );
        };

        const Dashboard = ({
            user,
            profile,
            activeTab,
            setActiveTab,
            mentorshipRequests,
            suggestedMentors,
            setSuggestedMentors,
            setMatchingState
        }) => {
            // REMOVED local activeTab state (now passed via props)

            // Initial state should be empty, waiting for DB fetch
            const [docs, setDocs] = useState([]);
            // Mock state for custom upload
            const [newDocName, setNewDocName] = useState('');
            // State for Housing "Additional" docs
            const [extraDocName, setExtraDocName] = useState('');

            // Housing Profile State (Synced with Firestore)
            const [housingProfile, setHousingProfile] = useState({
                budget: 800,
                guarantor: 'None',
                location: '', // Default: Restricted
            });

            // New state for Enrollment Status (Internal vs External)
            const [enrollmentStatus, setEnrollmentStatus] = useState('prospective'); // 'prospective' or 'enrolled'

            // Sync profile prop to local state when loaded
            React.useEffect(() => {
                if (profile) {
                    if (profile.housing) {
                        setHousingProfile(prev => ({ ...prev, ...profile.housing }));
                    }
                    if (profile.enrollmentStatus) {
                        setEnrollmentStatus(profile.enrollmentStatus);
                    }
                    // Load top-level location preference if available, else fallback to housing
                    if (profile.location) {
                        setHousingProfile(prev => ({ ...prev, location: profile.location }));
                    } else if (profile.housing && profile.housing.location) {
                        // Already handled by spread above, but ensures clarity
                    }
                }
            }, [profile]);

            // Real-time Jobs State (Moved to top level to avoid Hook errors)
            const [realJobs, setRealJobs] = useState([]);

            React.useEffect(() => {
                if (!window.db) return;
                const unsubscribe = window.db.collection('jobs')
                    .where('status', '==', 'Active')
                    .onSnapshot(snapshot => {
                        const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setRealJobs(jobs);
                    });
                return () => unsubscribe();
            }, []);

            const saveHousingPreferences = async () => {
                if (!user) return;
                try {
                    await window.db.collection('users').doc(user.uid).set({
                        housing: housingProfile
                    }, { merge: true });
                    alert("Housing Preferences Saved! âœ“");
                } catch (e) {
                    console.error("Error saving housing config:", e);
                    alert("Save failed: " + e.message);
                }
            };
            // New state for Services Needed (Modular Form)
            const [services, setServices] = useState({
                university: true,
                housing: true,
                jobs: true,
                mentorship: true
            });

            const toggleService = (service) => {
                setServices(prev => ({ ...prev, [service]: !prev[service] }));
            };

            // --- DATA FETCHING (Persistence) ---
            React.useEffect(() => {
                if (!user || !window.db) return;

                // 1. Fetch Documents
                console.log("Fetching documents for user:", user.uid);
                const unsubscribeDocs = window.db.collection('users').doc(user.uid).collection('documents')
                    .orderBy('date', 'desc') // Optional: Order by date if you add a timestamp
                    .onSnapshot(snapshot => {
                        const loadedDocs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        console.log("Fetched Docs:", loadedDocs);
                        // Always update state, even if empty, to reflect "0 documents"
                        setDocs(loadedDocs);
                    }, err => console.log("Docs fetch error", err));

                // 2. Fetch Applications
                const unsubscribeApps = window.db.collection('users').doc(user.uid).collection('applications')
                    .onSnapshot(snapshot => {
                        // Can store logic here if needed
                    }, err => console.log("Apps fetch error", err));

                return () => {
                    unsubscribeDocs();
                    unsubscribeApps();
                };
            }, [user]);
            // -----------------------------------

            // --- AI MATCH LISTENER ---
            const [aiMatches, setAiMatches] = useState(null);

            useEffect(() => {
                if (!user || !window.db) return;
                const unsubscribe = window.db.collection('users').doc(user.uid)
                    .collection('ai_matches').doc('latest')
                    .onSnapshot(doc => {
                        if (doc.exists) setAiMatches(doc.data());
                    });
                return () => unsubscribe();
            }, [user]);

            // --- AUTO-MATCHING AI (Background Agent) ---
            const generateAutoMatches = async (uid, profile) => {
                console.log("ðŸ¤– AI Agent: Triggering Auto-Match for", uid);

                // 1. School Matching (Deep Search Logic)
                let schoolMatches = [];
                const coursePref = (profile.education?.course1 || '').toLowerCase();

                if (coursePref.includes('computer') || coursePref.includes('data') || coursePref.includes('cyber')) {
                    schoolMatches = [
                        { id: 201, school: 'TalTech', program: 'MSc Cyber Security', city: 'Tallinn, Estonia', match: 96, tuition: 'â‚¬6,000/yr' },
                        { id: 301, school: 'Wroclaw Uni of Tech', program: 'MSc Applied CS', city: 'Wroclaw, Poland', match: 92, tuition: 'â‚¬3,700/yr' }
                    ];
                } else if (coursePref.includes('business') || coursePref.includes('management') || coursePref.includes('marketing')) {
                    schoolMatches = [
                        { id: 101, school: 'Emlyon', program: 'MSc Digital Marketing', city: 'Lyon, France', match: 94, tuition: 'â‚¬24,000/yr' },
                        { id: 401, school: 'Nova SBE', program: 'MSc Management', city: 'Lisbon, Portugal', match: 91, tuition: 'â‚¬12,000/yr' }
                    ];
                } else {
                    // Generic Fallback
                    schoolMatches = [
                        { id: 501, school: 'TU Munich', program: 'MSc Informatics', city: 'Munich, Germany', match: 88, tuition: 'â‚¬0' }
                    ];
                }

                // 2. Housing Matching
                let housingMatches = [];
                /* Logic could use profile.housing.budget */
                housingMatches = [
                    { id: 'h1', title: 'Student Residence Hall', city: profile.education?.preferredCity || 'Paris', price: 'â‚¬850/mo', match: 95 },
                    { id: 'h2', title: 'Shared Apartment (Coloc)', city: profile.education?.preferredCity || 'Paris', price: 'â‚¬600/mo', match: 88 }
                ];

                // 3. Job Matching
                let jobMatches = [
                    { id: 'j1', title: 'English Speaking Intern', company: 'TechStartup', location: 'Remote', match: 92, tags: ['English', 'Remote', 'Entry Level'] },
                    { id: 'j2', title: 'Marketing Assistant', company: 'Global Brands', location: 'Paris', match: 85, tags: ['Marketing', 'French B1', 'Social Media'] }
                ];

                // 4. Mentorship Matching
                let mentorMatches = [
                    { id: 'm1', name: 'Sarah (Year 2)', origin: 'Alumni', match: 98 }
                ];

                const fullMatchReport = {
                    date: new Date().toISOString(),
                    schools: schoolMatches,
                    housing: housingMatches,
                    jobs: jobMatches,
                    mentorship: mentorMatches,
                    status: 'completed'
                };

                // Persist to Firestore
                try {
                    await window.db.collection('users').doc(uid).collection('ai_matches').doc('latest').set(fullMatchReport);
                    console.log("âœ… AI Auto-Match Completed & Saved!");
                } catch (e) {
                    console.error("AI Match Failed:", e);
                }
            };

            // --- SAVE LOGIC (Robust & Simple) ---
            const saveProfile = async () => {
                if (!user || !window.db) return;
                const btn = document.getElementById('btn-save-profile');
                if (btn) { btn.innerText = 'Saving...'; btn.disabled = true; }

                // Gather data safely from DOM
                const getData = (id) => document.getElementById(id)?.value || '';

                const profileData = {
                    name: getData('input-name') || user.displayName,
                    degree: getData('input-degree'),
                    bio: getData('input-bio'),
                    enrollmentStatus: enrollmentStatus, // Persist Status
                    location: getData('input-location'), // Persist Location
                    education: {
                        level: getData('input-level'),
                        preferredCity: getData('input-city'),
                        course1: getData('input-course1'),
                        course2: getData('input-course2'),
                        course3: getData('input-course3')
                    },
                    skills: getData('input-skills'),
                    hobbies: getData('input-hobbies'),
                    lastUpdated: new Date()
                };

                try {
                    await window.db.collection('users').doc(user.uid).set(profileData, { merge: true });

                    // TRIGGER AUTO-MATCH
                    await generateAutoMatches(user.uid, profileData);

                    if (btn) btn.innerText = 'Saved! âœ“';
                    /* Force reload to update NavBar name if changed */
                    if (profileData.name !== user.displayName) setTimeout(() => window.location.reload(), 1500);
                } catch (e) {
                    console.error("Save failed:", e);
                    if (btn) btn.innerText = 'Error!';
                }

                setTimeout(() => {
                    if (btn) { btn.innerText = 'Save Profile'; btn.disabled = false; }
                }, 3000);
            };
            // ------------------------------------

            const [uploading, setUploading] = useState(false);
            const [selectedFile, setSelectedFile] = useState(null);

            // --- GENERIC UPLOAD HELPER ---
            const uploadDocument = async (file, name, type = 'custom') => {
                const cloudName = "dapmg0oku";
                const uploadPreset = "Alora download";
                const formData = new FormData();
                formData.append("file", file);
                formData.append("upload_preset", uploadPreset);

                // Force 'raw' resource type
                const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/raw/upload`, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) throw new Error("Cloudinary Error: " + response.statusText);

                const data = await response.json();
                const url = data.secure_url;
                const docId = String(Date.now()); // Safe String ID

                const newDoc = {
                    id: docId,
                    name: name,
                    url: url,
                    type: type,
                    status: 'uploaded',
                    date: new Date().toLocaleDateString()
                };

                // Update State & DB
                setDocs(prev => [...prev, newDoc]);
                await window.db.collection('users').doc(user.uid).collection('documents').doc(docId).set(newDoc);
                return newDoc;
            };

            const uploadFile = async () => {
                if (!selectedFile || !newDocName) {
                    alert("Please select a file and enter a name.");
                    return;
                }
                if (!user) { alert("System not ready."); return; }

                setUploading(true);
                try {
                    await uploadDocument(selectedFile, newDocName, 'custom');
                    setNewDocName('');
                    setSelectedFile(null);
                    const fileInput = document.getElementById('doc-upload-input');
                    if (fileInput) fileInput.value = null;
                    alert("Upload Successful! âœ“");
                } catch (error) {
                    console.error("Upload Error:", error);
                    alert("Upload failed: " + error.message);
                }
                setUploading(false);
            };

            // NEW: Handle Housing Specific Uploads
            const handleHousingUpload = async (file, docName) => {
                if (!file) return;
                try {
                    // Check if doc already exists? Optional: Overwrite logic could be added here
                    await uploadDocument(file, docName, 'housing');
                    alert(`${docName} Uploaded! âœ“`);
                } catch (error) {
                    alert("Housing Upload Failed: " + error.message);
                }
            };

            // Handle Extra Housing Uploads
            const handleExtraUpload = async (file) => {
                if (!file) return;
                if (!extraDocName.trim()) { alert("Please enter a document name first."); return; }
                try {
                    await uploadDocument(file, extraDocName, 'housing_extra');
                    setExtraDocName('');
                    alert(`${extraDocName} Uploaded! âœ“`);
                } catch (error) {
                    alert("Upload Failed: " + error.message);
                }
            };

            // Handle CV Upload
            const handleCVUpload = async (file) => {
                if (!file) return;
                try {
                    await uploadDocument(file, 'My Resume (CV)', 'cv');
                    alert("CV Uploaded Successfully! âœ“");
                } catch (error) {
                    alert("CV Upload Failed: " + error.message);
                }
            };

            const handleDelete = async (docId) => {
                const docToDelete = docs.find(d => d.id === docId);
                const confirmDelete = window.confirm(`Are you sure you want to delete "${docToDelete ? docToDelete.name : 'this document'}"?`);
                if (!confirmDelete) return;

                // Optimistic UI Update
                setDocs(prev => prev.filter(d => d.id !== docId));

                console.log("Attempting to delete doc:", docId, "for user:", user.uid);
                try {
                    await window.db.collection('users').doc(user.uid).collection('documents').doc(String(docId)).delete();
                    console.log("Delete successful in Firestore");
                } catch (error) {
                    console.error("Delete failed:", error);
                    alert("Delete failed: " + error.message);
                }
            };

            const applyToJob = async (job) => {
                if (!user) return;

                // check for CV
                const hasCV = docs.some(d => d.type === 'cv');
                if (!hasCV) {
                    alert("âš ï¸ Please upload your CV before applying.");
                    return;
                }

                const newApp = {
                    id: Date.now(),
                    type: 'job',
                    title: job.title,
                    subtitle: job.company,
                    status: 'submitted',
                    statusLabel: 'Applied',
                    date: new Date().toLocaleDateString(),
                    icon: 'briefcase',
                    color: 'text-blue-600',
                    bgColor: 'bg-blue-50',
                    details: 'Application sent to employer.'
                };

                // Optimistic UI updates
                alert(`Applied to ${job.title}! Track it in 'My Applications'.`);

                // Firestore write
                try {
                    // 1. Save to Student's private collection (for their dashboard)
                    await window.db.collection('users').doc(user.uid).collection('applications').doc(String(newApp.id)).set(newApp);

                    // 2. Save to Global 'job_applications' collection (for Corporate portal)
                    const globalAppKey = `${newApp.id}_${user.uid}`;
                    await window.db.collection('job_applications').doc(globalAppKey).set({
                        ...newApp,
                        studentId: user.uid,
                        studentName: (profile && profile.name) || user.displayName || 'Unknown Student',
                        cvUrl: docs.find(d => d.type === 'cv')?.url || '',
                        jobId: (job.title + job.company).replace(/[^a-zA-Z0-9]/g, '_'), // Best effort ID
                        companyName: job.company
                    });

                    alert("Application Sent! ðŸš€");
                    // No need to manually prompt "Saved" as button will update
                } catch (e) {
                    console.error("App submit error", e);
                    alert("Application error: " + e.message);
                }
            };

            // SAVED JOBS LOGIC
            const [savedJobs, setSavedJobs] = useState([]);

            // Listen for Saved Jobs
            React.useEffect(() => {
                if (!user || !window.db) return;
                const unsubscribe = window.db.collection('users').doc(user.uid).collection('saved_jobs')
                    .onSnapshot(snapshot => {
                        const jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setSavedJobs(jobs);
                    });
                return () => unsubscribe();
            }, [user]);

            const toggleSaveJob = async (job) => {
                if (!user) return;
                // Generate a consistent ID based on job content
                const jobId = (job.title + job.company).replace(/[^a-zA-Z0-9]/g, '_');

                const isSaved = savedJobs.some(j => j.id === jobId);

                try {
                    if (isSaved) {
                        await window.db.collection('users').doc(user.uid).collection('saved_jobs').doc(jobId).delete();
                    } else {
                        await window.db.collection('users').doc(user.uid).collection('saved_jobs').doc(jobId).set({
                            ...job,
                            id: jobId,
                            savedAt: new Date().toISOString()
                        });
                    }
                } catch (e) {
                    console.error("Save toggle error", e);
                    alert("Could not update saved jobs.");
                }
            };

            const handleRename = (id, newName) => {
                setDocs(docs.map(d => d.id === id ? { ...d, name: newName } : d));
            };

            // Unified Applications State
            const [allApplications, setAllApplications] = useState([]);

            // Listen for Real Applications (Jobs + Personal)
            React.useEffect(() => {
                if (!user || !window.db) return;

                // 1. Job Applications (Global collection, filtered by studentId)
                const unsubscribeJobs = window.db.collection('job_applications')
                    .where('studentId', '==', user.uid)
                    .onSnapshot(snapshot => {
                        const jobApps = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                type: 'job',
                                title: data.title,
                                subtitle: data.companyName,
                                status: 'submitted', // Default for now
                                statusLabel: 'Applied',
                                date: new Date().toLocaleDateString(), // Mock date if missing
                                icon: 'briefcase',
                                color: 'text-blue-600',
                                bgColor: 'bg-blue-50',
                                details: 'Application sent to employer.',
                                collection: 'job_applications' // For delete logic
                            };
                        });
                        setJobApplications(jobApps);
                    });

                return () => unsubscribeJobs();
            }, [user]);

            // Separate states for merging
            const [jobApplications, setJobApplications] = useState([]);
            const [otherApplications, setOtherApplications] = useState([]);

            const [properties, setProperties] = useState([]);

            // Listen for Real Properties (Available Only)
            React.useEffect(() => {
                if (!window.db) return;
                const unsubscribe = window.db.collection('properties')
                    .where('status', '==', 'Vacant')
                    .onSnapshot(snapshot => {
                        const props = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setProperties(props);
                    });
                return () => unsubscribe();
            }, []);

            // Listen for Other Applications
            React.useEffect(() => {
                if (!user || !window.db) return;
                const unsubscribeApps = window.db.collection('users').doc(user.uid).collection('applications')
                    .onSnapshot(snapshot => {
                        const otherApps = snapshot.docs.map(doc => {
                            const data = doc.data();
                            return {
                                id: doc.id,
                                type: data.type || 'university',
                                title: data.title,
                                ...data,
                                collection: `users/${user.uid}/applications`
                            };
                        });
                        setOtherApplications(otherApps);
                    });
                return () => unsubscribeApps();
            }, [user]);

            // Merge effects
            React.useEffect(() => {
                const all = [...jobApplications, ...otherApplications];
                const unique = Array.from(new Map(all.map(item => [item.id, item])).values());
                setAllApplications(unique);
            }, [jobApplications, otherApplications]);

            const handleWithdraw = async (app) => {
                if (!confirm("Are you sure you want to withdraw this application?")) return;
                try {
                    await window.db.collection(app.collection).doc(app.id).delete();
                    if (app.type === 'job') {
                        // We also saved to users/uid/applications in applyToJob. Let's try to delete that too.
                        await window.db.collection('users').doc(user.uid).collection('applications').doc(app.id.split('_')[0]).delete().catch(e => console.warn("Could not delete private copy", e));
                    }
                } catch (e) {
                    console.error("Withdraw Error", e);
                    alert("Failed to withdraw application.");
                }
            };

            // --- FEATURE UNLOCK LOGIC ---
            const isHousingUnlocked = enrollmentStatus === 'enrolled';
            const isLifestyleUnlocked = housingProfile.location === 'In France (Have Visa)';

            return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* Tabs */}
                    <div className="flex overflow-x-auto gap-2 border-b border-gray-200 mb-8">
                        {[
                            { id: 'intake', label: 'Student Profile' },
                            { id: 'housing', label: 'Find Housing', locked: !isHousingUnlocked, reason: "You must be 'Already Enrolled' to access housing." },
                            { id: 'jobs', label: 'Student Jobs', locked: !isLifestyleUnlocked, reason: "You must be 'In France' to access jobs." },
                            { id: 'mentorship', label: 'Mentorship', locked: !isLifestyleUnlocked, reason: "You must be 'In France' to access mentorship." },
                            { id: 'applications', label: 'My Applications' },
                            { id: 'documents', label: 'Document Vault' }
                        ].map(tab => {
                            const isLocked = tab.locked;
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => {
                                        if (isLocked) {
                                            alert(`ðŸ”’ Restricted Access\n\n${tab.reason}\n\nPlease update your Profile status to unlock.`);
                                        } else {
                                            setActiveTab(tab.id);
                                        }
                                    }}
                                    className={`px-6 py-3 font-bold text-sm uppercase tracking-wide whitespace-nowrap transition-colors border-b-2 flex items-center gap-2 
                                        ${activeTab === tab.id ? 'border-peach-accent text-navy-primary' :
                                            isLocked ? 'border-transparent text-gray-300 cursor-not-allowed' : 'border-transparent text-gray-500 hover:text-gray-700'}`}
                                >
                                    {tab.label}
                                    {isLocked && <Icon name="lock" size={14} />}
                                </button>
                            );
                        })}
                    </div>

                    {/* Content */}
                    <div className="min-h-[500px]">
                        {/* 1. STUDENT INTAKE */}
                        {activeTab === 'intake' && (
                            <div className="animate-fade-in max-w-4xl mx-auto">
                                <div className="bg-white p-8 rounded-lg shadow-sm border border-gray-200">
                                    <div className="mb-8 border-b border-gray-100 pb-4">
                                        <h2 className="text-2xl font-bold text-navy-primary mb-2">Master Profile</h2>
                                        <p className="text-gray-500 text-sm">One profile to power your entire journey: Universities, Housing, Jobs, and Mentorship.</p>
                                    </div>

                                    <form className="space-y-8" onSubmit={(e) => e.preventDefault()}>
                                        {/* Status Toggle */}
                                        <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 flex flex-col md:flex-row gap-4 items-center justify-between">
                                            <div>
                                                <h4 className="font-bold text-navy-primary text-sm">Where are you in your journey?</h4>
                                                <p className="text-xs text-blue-700">Select the option that best describes you.</p>
                                            </div>
                                            <div className="flex bg-white rounded-full p-1 border border-blue-200 shadow-sm">
                                                <button onClick={() => setEnrollmentStatus('prospective')} className={`px-4 py-2 rounded-full text-xs font-bold transition ${enrollmentStatus === 'prospective' ? 'bg-navy-primary text-white shadow' : 'text-gray-500 hover:text-navy-primary'}`}>Applying to School</button>
                                                <button onClick={() => setEnrollmentStatus('enrolled')} className={`px-4 py-2 rounded-full text-xs font-bold transition ${enrollmentStatus === 'enrolled' ? 'bg-navy-primary text-white shadow' : 'text-gray-500 hover:text-navy-primary'}`}>Already Enrolled</button>
                                            </div>
                                        </div>

                                        {/* Service Selection */}
                                        <div>
                                            <h3 className="font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide">Select Services You Need</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                {['university', 'housing', 'jobs', 'mentorship'].map(s => (
                                                    <div key={s} onClick={() => toggleService(s)} className={`cursor-pointer p-4 rounded-lg border text-center transition ${services[s] ? 'bg-navy-primary text-white border-navy-primary' : 'bg-white text-gray-500 border-gray-200 hover:border-gray-300'}`}>
                                                        <div className="mb-2"><Icon name={s === 'university' ? 'graduationCap' : s === 'housing' ? 'home' : s === 'jobs' ? 'briefcase' : 'users'} size={20} className="mx-auto" /></div>
                                                        <div className="text-xs font-bold capitalize">{s}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        {/* Core Info */}
                                        <div className="grid md:grid-cols-2 gap-6">
                                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Full Name</label><input id="input-name" type="text" defaultValue={profile?.name || user?.displayName || ''} className="w-full p-3 border rounded bg-gray-50 text-gray-900 border-gray-200 focus:border-peach-accent outline-none" /></div>
                                            <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Current Degree/Qualification</label><input id="input-degree" type="text" defaultValue={profile?.degree || ''} className="w-full p-3 border rounded bg-gray-50 text-gray-900 border-gray-200 focus:border-peach-accent outline-none" /></div>
                                        </div>

                                        {/* Study Info */}
                                        {services.university && (
                                            <div className="animate-fade-in border-t border-gray-100 pt-6">
                                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><div className="w-6 h-6 rounded-full bg-navy-primary text-white flex items-center justify-center text-xs">A</div> {enrollmentStatus === 'prospective' ? 'Study Preferences' : 'Current Enrollment'}</h3>
                                                {enrollmentStatus === 'prospective' ? (
                                                    <div className="grid md:grid-cols-2 gap-6 mb-4">
                                                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Level</label><select id="input-level" className="w-full p-3 border rounded"><option>Bachelor's</option><option>Master's</option></select></div>
                                                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">City</label><input id="input-city" defaultValue={profile?.education?.preferredCity || ''} type="text" className="w-full p-3 border rounded" /></div>
                                                        <div className="col-span-2"><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Top Course</label><input id="input-course1" defaultValue={profile?.education?.course1 || ''} type="text" className="w-full p-3 border rounded" /></div>
                                                    </div>
                                                ) : (
                                                    <div className="bg-gray-50 p-6 rounded border border-gray-200"><div className="grid md:grid-cols-2 gap-6"><div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">School</label><input type="text" className="w-full p-3 border rounded" /></div><div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">City</label><input type="text" className="w-full p-3 border rounded" /></div>
                                                        <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Residency Status</label><select id="input-location" defaultValue={profile?.location || 'In Home Country'} className="w-full p-3 border rounded"><option>In Home Country</option><option>In France (Have Visa)</option><option>In France (No Visa)</option></select></div>
                                                    </div></div>
                                                )}
                                            </div>
                                        )}

                                        {/* Housing Info */}
                                        {services.housing && (
                                            <div className="pt-6 border-t border-gray-100 animate-fade-in">
                                                <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><div className="w-6 h-6 rounded-full bg-peach-accent text-white flex items-center justify-center text-xs">B</div> Housing</h3>
                                                <div className="grid md:grid-cols-2 gap-6">
                                                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Max Budget</label><input type="number" value={housingProfile.budget} onChange={e => setHousingProfile({ ...housingProfile, budget: e.target.value })} className="w-full p-3 border rounded" /></div>
                                                    <div><label className="block text-xs font-bold text-gray-500 uppercase mb-2">Guarantor</label><select value={housingProfile.guarantor} onChange={e => setHousingProfile({ ...housingProfile, guarantor: e.target.value })} className="w-full p-3 border rounded"><option>Visale</option><option>None</option></select></div>
                                                </div>
                                            </div>
                                        )}

                                        {/* Narrative */}
                                        <div className="pt-4 border-t border-gray-100">
                                            <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><div className="w-6 h-6 rounded-full bg-peach-accent text-white flex items-center justify-center text-xs">C</div> Personal Statement</h3>
                                            <textarea id="input-bio" defaultValue={profile?.bio || ''} className="w-full p-4 border rounded h-32" placeholder="Tell us about yourself..."></textarea>
                                        </div>

                                        <div className="pt-4 flex justify-end">
                                            <button id="btn-save-profile" onClick={saveProfile} className="bg-navy-primary text-white font-bold py-3 px-8 rounded shadow-lg hover:bg-navy-dark transition uppercase tracking-wide">Save Profile</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        {/* 4. HOUSING */}
                        {activeTab === 'housing' && (
                            <div className="animate-fade-in">
                                <div className="mb-8">
                                    <h3 className="font-bold text-navy-primary mb-4 flex items-center gap-2"><Icon name="home" /> Available Listings</h3>
                                    {properties.length === 0 ? <p className="text-gray-400 text-sm italic">No properties listed yet.</p> : (
                                        <div className="grid md:grid-cols-2 gap-4">
                                            {properties.map(p => (
                                                <div key={p.id} className="bg-white border hover:border-peach-accent transition p-4 rounded shadow-sm relative group cursor-pointer"
                                                    onClick={async () => {
                                                        if (confirm(`Start application for ${p.name}?`)) {
                                                            try {
                                                                await window.db.collection('users').doc(user.uid).collection('applications').add({
                                                                    type: 'housing',
                                                                    title: p.name,
                                                                    subtitle: p.location,
                                                                    status: 'submitted',
                                                                    statusLabel: 'Application Sent',
                                                                    date: new Date().toLocaleDateString(),
                                                                    icon: 'home',
                                                                    color: 'text-peach-accent',
                                                                    details: `Application for ${p.name} at â‚¬${p.rent}/mo.`,
                                                                    createdAt: new Date().toISOString()
                                                                });
                                                                alert("Application Sent! Check 'My Applications'.");
                                                            } catch (e) { console.error(e); alert("Error applying."); }
                                                        }
                                                    }}
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <div><h5 className="font-bold text-gray-900">{p.name}</h5><p className="text-xs text-gray-500">{p.location}</p></div>
                                                        <span className="font-bold text-peach-accent">â‚¬{p.rent}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* JOBS */}
                        {activeTab === 'jobs' && (
                            <div className="animate-fade-in max-w-5xl mx-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold text-navy-primary">Corporate Career Matching</h2>
                                    <div className="bg-blue-50 text-blue-800 px-4 py-2 rounded text-xs font-bold flex items-center gap-2"><Icon name="sparkles" size={16} /> System Status: Finding Best Fits...</div>
                                </div>
                                <div className="space-y-4">
                                    {realJobs.map(job => (
                                        <div key={job.id} className="bg-white p-6 rounded-lg shadow-sm border border-gray-100 hover:shadow-md transition relative group">
                                            <div className="flex justify-between items-start mb-4">
                                                <div><h4 className="font-bold text-lg text-navy-primary">{job.title}</h4><p className="font-bold text-gray-600 text-sm mb-1">{job.company}</p></div>
                                                <button onClick={() => applyToJob(job)} className="bg-navy-primary text-white font-bold py-2 px-4 rounded text-sm hover:bg-navy-dark transition">Apply</button>
                                            </div>
                                        </div>
                                    ))}
                                    {realJobs.length === 0 && <p className="text-gray-500 italic">No active job listings found.</p>}
                                </div>
                            </div>
                        )}

                        {/* MENTORSHIP */}
                        {activeTab === 'mentorship' && (
                            <div>
                                <h2 className="text-2xl font-bold text-navy-primary mb-4">My Mentorship</h2>
                                <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 mb-6">
                                    {mentorshipRequests.length === 0 && !window.isMatching && (
                                        <div className="bg-white p-8 border border-dashed border-gray-300 flex flex-col items-center text-center">
                                            <div className="bg-purple-100 text-purple-600 rounded-full h-16 w-16 flex items-center justify-center mb-4"><Icon name="users" size={32} /></div>
                                            <h4 className="text-lg font-bold text-gray-900 mb-2">Find Your Perfect Mentor</h4>
                                            <p className="text-sm text-gray-500 mb-6 max-w-sm">The System will analyze your profile and match you with the best local mentors.</p>
                                            <button onClick={() => setMatchingState('scanning')} className="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow hover:bg-purple-700 transition flex items-center gap-2"><Icon name="sparkles" size={16} /> Start Smart Match Scanner</button>
                                        </div>
                                    )}

                                    {window.isMatching === 'scanning' && (
                                        <div className="py-12 flex flex-col items-center text-center">
                                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mb-6"></div>
                                            <h4 className="text-xl font-bold text-navy-primary mb-2">System Scanning...</h4>
                                            <MatchLogicRunner user={user} profile={profile} onMatchesFound={(matches) => { setSuggestedMentors(matches); setMatchingState('results'); }} />
                                        </div>
                                    )}

                                    {window.isMatching === 'results' && (
                                        <div className="space-y-6">
                                            <h4 className="font-bold text-lg text-navy-primary">Top Matches Found</h4>
                                            <div className="grid md:grid-cols-2 gap-4">
                                                {suggestedMentors.map(mentor => (
                                                    <div key={mentor.id} className="border border-green-200 bg-green-50 p-6 rounded-lg relative overflow-hidden">
                                                        <h5 className="font-bold text-lg mb-1">{mentor.name}</h5>
                                                        <p className="text-xs text-gray-600 mb-3 flex items-center gap-1"><Icon name="mapPin" size={12} /> {mentor.housing?.location || 'France'}</p>
                                                        <button onClick={async () => {
                                                            if (confirm(`Connect with ${mentor.name}?`)) {
                                                                await window.db.collection('mentorship_requests').add({ studentId: user.uid, studentName: profile?.name || 'Student', mentorId: mentor.id, mentorName: mentor.name, status: 'Pending Mentor Approval', createdAt: new Date().toISOString() });
                                                                setMatchingState('idle'); alert("Request Sent!");
                                                            }
                                                        }} className="w-full bg-navy-primary text-white font-bold py-2 rounded shadow hover:bg-navy-dark transition">Connect Request</button>
                                                    </div>
                                                ))}
                                            </div>
                                            <button onClick={() => setMatchingState('idle')} className="text-sm text-gray-500 underline mt-4">Cancel Search</button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* DOCS & APPS */}
                        {activeTab === 'documents' && (
                            <div className="animate-fade-in max-w-5xl mx-auto">
                                <h3 className="font-bold text-gray-800 mb-4">Your Vault</h3>
                                <div className="bg-white rounded-lg shadow-sm border border-gray-200">
                                    {docs.map(doc => (
                                        <div key={doc.id} className="flex justify-between items-center p-4 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition">
                                            <div className="flex items-center gap-4"><div className="w-10 h-10 rounded bg-blue-100 text-blue-600 flex items-center justify-center"><Icon name="fileText" size={20} /></div>
                                                <div><a href={doc.url} target="_blank" className="font-bold text-gray-800 text-sm hover:text-blue-600">{doc.name}</a><div className="text-xs text-gray-500 uppercase">{doc.type}</div></div></div>
                                            <button onClick={() => handleDelete(doc.id)} className="text-red-400 hover:text-red-600"><Icon name="trash2" size={16} /></button>
                                        </div>
                                    ))}
                                    {docs.length === 0 && <div className="p-8 text-center text-gray-400 italic">No documents uploaded yet.</div>}
                                </div>
                            </div>
                        )}

                        {activeTab === 'applications' && (
                            <div className="animate-fade-in space-y-6 max-w-4xl mx-auto">
                                <h2 className="font-bold text-navy-primary text-xl">Track All Applications</h2>
                                {allApplications.map(app => (
                                    <div key={app.id} className="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                                        <h3 className="font-bold text-sm text-gray-900">{app.title}</h3>
                                        <p className="text-xs text-gray-500">{app.subtitle}</p>
                                        <span className="text-xs font-bold text-blue-600 uppercase">{app.statusLabel}</span>
                                    </div>
                                ))}
                            </div>
                        )}

                    </div>
                </div>
            );
        };

        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true }; }
            componentDidCatch(error, errorInfo) {
                this.setState({ error, errorInfo });
                console.error("ErrorBoundary caught an error", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-8 text-center">
                            <h2 className="text-xl font-bold text-red-600 mb-4">Something went wrong.</h2>
                            <details className="text-left bg-gray-100 p-4 rounded whitespace-pre-wrap text-xs font-mono text-red-800">
                                {this.state.error && this.state.error.toString()}
                            </details>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const MatchLogicRunner = ({ user, profile, onMatchesFound }) => {
            useEffect(() => {
                const runScan = async () => {
                    await new Promise(r => setTimeout(r, 2000));
                    try {
                        const snapshot = await window.db.collection('users').where('mentorship.isMentor', '==', true).get();
                        const mentors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        const scored = mentors.map(mentor => {
                            let score = 50;
                            // Mock Score
                            return { ...mentor, score: Math.floor(Math.random() * (99 - 70) + 70), reasons: ['Available'] };
                        });
                        onMatchesFound(scored.slice(0, 3));
                    } catch (e) {
                        console.error(e);
                        onMatchesFound([{ id: 'mock1', name: 'Jean Dupont', housing: { location: 'Montpellier' }, score: 95, reasons: ['Mock Match'] }]);
                    }
                };
                runScan();
            }, []);
            return null;
        };

        const App = () => {
            console.log(" DEBUG: App render");
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('housing');

            // Mentorship State
            const [mentorshipRequests, setMentorshipRequests] = useState([]);
            const [suggestedMentors, setSuggestedMentors] = useState([]);

            // Expose matching state to window for simple UI switching
            const [matchingState, setMatchingState] = useState('idle');
            window.isMatching = matchingState;

            useEffect(() => {
                let unsubscribeProfile;
                let unsubscribeRequests;

                const unsubscribeAuth = window.auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser(u);
                        setLoading(false);
                        if (window.db) {
                            unsubscribeProfile = window.db.collection('users').doc(u.uid).onSnapshot(doc => { if (doc.exists) setProfile(doc.data()); });
                            unsubscribeRequests = window.db.collection('mentorship_requests').where('studentId', '==', u.uid).onSnapshot(snapshot => { setMentorshipRequests(snapshot.docs.map(d => ({ id: d.id, ...d.data() }))); });
                        }
                    } else {
                        window.location.href = 'login.html';
                        setLoading(false);
                    }
                });

                return () => {
                    unsubscribeAuth();
                    if (unsubscribeProfile) unsubscribeProfile();
                    if (unsubscribeRequests) unsubscribeRequests();
                };
            }, []);

            if (loading) return <div className="h-screen flex items-center justify-center"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div></div>;

            return (
                <div>
                    <NavBar user={user} />
                    <ErrorBoundary>
                        <Dashboard
                            user={user}
                            profile={profile}
                            activeTab={activeTab}
                            setActiveTab={setActiveTab}
                            mentorshipRequests={mentorshipRequests}
                            suggestedMentors={suggestedMentors}
                            setSuggestedMentors={setSuggestedMentors}
                            setMatchingState={setMatchingState}
                        />
                    </ErrorBoundary>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>